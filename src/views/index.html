<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Management App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col">
        <h3>Add Employee</h3>
        <form class="mb-5">
          <label class="form-label" for="newEmployee"></label>
          <input type="text" class="form-control" id="newEmployee" placeholder="Employee Name" />
          <button type="button" id="addEmployeeBtn" class="btn btn-primary mt-3">
            Add
          </button>
        </form>
      </div>
      <div class="col">
        <h3>Add Project</h3>
        <form>
          <label class="form-label" for="newProject"></label>
          <input type="text" class="form-control" id="newProject" placeholder="Project Name" />
          <button type="button" id="addProjectBtn" class="btn btn-primary mt-3">
            Add
          </button>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col">
        <h3>Employee List</h3>
        <table id="employeeTable" class="table table-striped table-hover">
        </table>
      </div>
      <div class="col">
        <h3>Project List</h3>
        <table id="projectTable" class="table table-striped table-hover">
        </table>
      </div>
    </div>
    <div class="row">
      <div class="col" id="employeeInfo"></div>
      <div class="col" id="projectInfo"></div>
    </div>
  </div>
  <script>
    const employeeInput = document.getElementById('newEmployee');
    const addEmployeeBtn = document.getElementById('addEmployeeBtn');
    const employeeTable = document.getElementById('employeeTable');
    const projectInput = document.getElementById('newProject');
    const addProjectBtn = document.getElementById('addProjectBtn');
    const projectTable = document.getElementById('projectTable');

    const baseUrl = 'http://localhost:3001/';


    // SHOW EMPLOYEES
    async function showEmployees() {
      const res = await fetch(baseUrl + 'employees', {
        method: 'GET'
      })
      const data = await res.json();
      employeeTable.innerHTML = ''
      employeeTable.innerHTML = `<thead>
          <th>ID</th>
          <th>Name</th>
          </thead>
          <tbody>
            ${data.map((employee) => `<tr onclick="employeeProperties(${employee.id})"><td>${employee.id}</td><td>${employee.name}</td></tr>`).join('')}
          </tbody>
          `
    }
    employeeTable.onload = showEmployees()

    // ADD EMPLOYEES
    addEmployeeBtn.addEventListener('click', addEmployee);
    async function addEmployee(e) {
      e.preventDefault()
      const name = employeeInput.value
      const res = await fetch(baseUrl + 'employees', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name
        })
      })
      employeeInput.value = ''
      showEmployees()
    }


    // SHOW PROJECTS
    async function showProjects() {
      const projects = await fetch(baseUrl + 'projects', {
        method: 'GET'
      })
      const data = await projects.json();
      const names = [];
      for (let i = 0; i < data.length; i++) {
        const task = await showTask(data[i].id)
        names.push(task)
      }
      projectTable.innerHTML = ''
      projectTable.innerHTML = `<thead>
          <th>ID</th>
          <th>Name</th>
          <th>Assigned to</th>
          </thead>
          <tbody id="projectTableBody">
          </tbody>
          `

      for (let i = 0; i < data.length; i++) {
        const project = data[i];
        const projectTableBody = document.getElementById('projectTableBody');

        projectTableBody.innerHTML += `<tr id=projectTableRow onclick="projectProperties(${project.id})"><td>${project.id}</td><td>${project.name}</td><td id="projectTableTasks">${names[i]}</td></tr>`

      }
    }
    projectTable.onload = showProjects();

    // SHOW TASKS
    async function showTask(id) {
      const tasks = await fetch(baseUrl + 'tasks/project/' + id, {
        method: 'GET'
      })

      const taskJson = await tasks.json();
      const names = [];
      for (let i = 0; i < taskJson.length; i++) {
        const employeeData = await fetch(baseUrl + 'employees/' + taskJson[i].employee_id, {
          method: 'GET'
        })

        const employeeJson = await employeeData.json();
        names.push(employeeJson.name)
      }

      return names;
    }

    // ADD PROJECTS
    addProjectBtn.addEventListener('click', addProject);
    async function addProject(e) {
      e.preventDefault()
      const name = projectInput.value
      const res = await fetch(baseUrl + 'projects', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name
        })
      })
      projectInput.value = ''
      showProjects()
    }

    // EMPLOYEE INFO
    async function employeeProperties(id) {
      const res = await fetch(baseUrl + 'employees/' + id, {
        method: 'GET'
      })
      const data = await res.json();

      // get not assigned tasks information
      const notAssignedTask = await fetch(baseUrl + `tasks/employee/${id}/not`, {
        method: 'GET'
      })

      const notAssignedTaskJson = await notAssignedTask.json();
      let notAssignedTaskInfo = []
      for (let i = 0; i < notAssignedTaskJson.length; i++) {
        const notAssignedTaskData = await fetch(baseUrl + 'projects/' + notAssignedTaskJson[i].project_id, {
          method: 'GET'
        })
        notAssignedJson = await notAssignedTaskData.json();
        notAssignedTaskInfo.push(notAssignedJson)
      }

      // Get assigned tasks information
      const assignedTask = await fetch(baseUrl + 'tasks/employee/' + id, {
        method: 'GET'
      })
      const assignedTaskJson = await assignedTask.json();

      let taskInfo = []
      for (let i = 0; i < assignedTaskJson.length; i++) {
        const taskData = await fetch(baseUrl + 'projects/' + assignedTaskJson[i].project_id, {
          method: 'GET'
        })
        taskJson = await taskData.json();
        taskInfo.push(taskJson)
      }

      employeeInfo.innerHTML = ''
      employeeInfo.innerHTML = `
          <h2>Employee Info</h2>
          <form>
            <label class="form-label" for="employeeName${id}">Name</label>
            <input
              type="text"
              class="form-control"
              id="employeeName"
              placeholder="Employee Name"
              value = "${data.name}"
            />

            <label class="form-label mt-3" for="assignTask">Assign Project</label>
            <select id="assignEmployeeTask" class="form-select" name="Assign Task" >
              <option selected>None</option>
              ${notAssignedTaskInfo.map((task) => `<option>${task.id}</option>`).join('')}
            </select>

            <label class="form-label mt-3" for="removeTask">Remove Project</label>
            <select id="removeEmployeeTask" class="form-select" name="Remove Task" >
              <option selected>None</option>
              ${taskInfo.map((task) => `<option>${task.id}</option>`).join('')}
            </select>

            <button type="button" id="updateEmployeeBtn" class="btn btn-success mt-3" onclick="updateEmployee(${data.id})">
              Update
            </button>

            <button type="button" id="deleteEmployeeBtn" class="btn btn-danger mt-3" onclick="deleteEmployee(${data.id})">
              Delete
            </button>
          </form>
        `
    }

    // UPDATE EMPLOYEE
    async function updateEmployee(id) {
      const name = document.getElementById('employeeName').value
      await fetch(baseUrl + 'employees/' + id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name
        })
      })

      const assignTask = document.getElementById('assignEmployeeTask').value;
      const taskValue = parseInt(assignTask);
      if (assignTask !== 'None') {
        await fetch(baseUrl + 'tasks', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            project_id: taskValue,
            employee_id: id
          })
        })
      }

      const removeTask = document.getElementById('removeEmployeeTask').value
      if (removeTask !== 'None') {
        await fetch(baseUrl + `tasks/employee/${id}/task/` + removeTask, {
          method: 'DELETE'
        })
      }

      showEmployees()
      showProjects()
      employeeProperties(id)
    }

    // PROJECT INFO
    async function projectProperties(id) {
      const res = await fetch(baseUrl + 'projects/' + id, {
        method: 'GET'
      })
      const data = await res.json();

      projectInfo.innerHTML = ''
      projectInfo.innerHTML = `
          <h2>Project Info</h2>
          <form>
            <label class="form-label" for="projectName${id}">Name</label>
            <input
              type="text"
              class="form-control"
              id="projectName"
              placeholder="Employee Name"
              value = "${data.name}"
            />
            <button type="button" id="updateProjectBtn" class="btn btn-success mt-3" onclick="updateProject(${data.id})">
              Update
            </button>
            <button type="button" id="deleteProjectBtn" class="btn btn-danger mt-3" onclick="deleteProject(${data.id})">
              Delete
            </button>
          </form>
        `
    }

    // UPDATE PROJECT
    async function updateProject(id) {
      const name = document.getElementById('projectName').value
      const res = await fetch(baseUrl + 'projects/' + id, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name
        })
      })
      showProjects()
    }

    // DELETE EMPLOYEE
    async function deleteEmployee(id) {
      const res = await fetch(baseUrl + 'employees/' + id, {
        method: 'DELETE'
      })
      showEmployees()
      showProjects()
      employeeInfo.innerHTML = ''
    }

    // DELETE PROJECT
    async function deleteProject(id) {
      const res = await fetch(baseUrl + 'projects/' + id, {
        method: 'DELETE'
      })
      showProjects()
      projectInfo.innerHTML = ''
    }
  </script>
</body>

</html>
